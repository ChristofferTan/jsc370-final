---
title: "eda"
output: html_document
---

```{r}
library(ggplot2)
library(dplyr)
library(tidyr)
library(lubridate)
library(plotly)
library(zoo)
```

```{r}
df <- read.csv("../data/merged_data.csv")
```

```{r}
summary(df)
```

```{r}
plot_ly(df, x = ~hour, y = ~total_trips, type = "box")
```


```{r}
ggplot(df, aes(x = temp, y = humidity)) +
  geom_density_2d_filled(contour_var = "ndensity") +
  labs(
    title = "2D Density of Temperature and Humidity",
    x = "Temperature (°C)",
    y = "Humidity (%)"
  ) +
  theme_minimal()
```

```{r}
ggplot(df, aes(x = temp, y = pressure)) +
  geom_density_2d_filled(contour_var = "ndensity") +
  labs(
    title = "2D Density of Temperature and Humidity",
    x = "Temperature (°C)",
    y = "Humidity (%)"
  ) +
  theme_minimal()
```



```{r}
ggplot(df, aes(x = total_trips)) + 
  geom_histogram(bins = 30, fill = "skyblue", color = "white") +
  labs(title = "Distribution of Bike Trips")
```

```{r}
df |>
  select(temp, feels_like, humidity, wind_speed, cloudiness, precipitation, pressure) |>
  gather(key = "variable", value = "value") |>
  ggplot(aes(x = value)) +
  geom_histogram(bins = 30, fill = "lightgray", color = "black") +
  facet_wrap(~ variable, scales = "free") +
  labs(title = "Distribution of Weather Features")
```

```{r}
df |>
  count(weather_main) |>
  ggplot(aes(x = "", y = n, fill = weather_main)) +
  geom_col(width = 1) +
  scale_fill_brewer(palette = "RdYlGn") + 
  coord_polar(theta = "y") +
  labs(
    title = "Weather Condition Breakdown (Main)",
    fill = "Condition"
  ) +
  theme_void()

df %>%
  count(weather_desc, sort = TRUE) %>%
  slice_max(n, n = 10) %>%
  ggplot(aes(x = reorder(weather_desc, n), y = n, fill = weather_desc)) +
  geom_col(show.legend = FALSE) +
  scale_fill_brewer(palette = "RdYlGn") +
  coord_flip() +
  labs(
    title = "Top 10 Weather Descriptions",
    x = "Weather Description",
    y = "Frequency"
  ) +
  theme_minimal()

```

```{r}
daily_avg <- df %>%
  group_by(date) %>%
  summarise(avg_trips = mean(total_trips), .groups = "drop")

ggplot(daily_avg, aes(x = date, y = avg_trips)) +
  geom_line(color = "steelblue") +
  geom_point(color = "steelblue", alpha = 0.6) +
  labs(
    title = "Average Number of Bike Trips per Day",
    x = "Date",
    y = "Average Trips"
  ) +
  theme_minimal()
```

```{r}
df <- df %>%
  mutate(hour = factor(hour, levels = 0:23))

p1 <- plot_ly(
  data = df,
  x = ~hour,
  y = ~total_trips,
  type = "box",
  boxpoints = "suspectedoutliers",  # Show only unusual outliers
  jitter = 0.3,
  pointpos = -1.8,  # Adjusts how far points are from box
  marker = list(size = 4, opacity = 0.4, color = "#1f77b4"),
  line = list(color = "#1f77b4"),
  fillcolor = "rgba(173, 216, 230, 0.4)"
) %>%
  layout(
    title = list(
      text = "Hourly Distribution of Total Bike Trips",
      x = 0.5,
      font = list(size = 18, family = "Arial", color = "#222")
    ),
    xaxis = list(
      title = "Hour of the Day",
      tickmode = "linear",
      tick0 = 0,
      dtick = 1
    ),
    yaxis = list(
      title = "Total Trips",
      rangemode = "tozero"
    ),
    margin = list(l = 60, r = 30, t = 80, b = 60),
    plot_bgcolor = "#fff",
    paper_bgcolor = "#fff",
    font = list(family = "Arial", size = 12)
  )


p1

```


```{r}
library(dplyr)
library(caret)
library(randomForest)
```


```{r}
set.seed(123)
split_index <- createDataPartition(df$total_trips, p = 0.8, list = FALSE)
train_df <- df[split_index, ]
test_df  <- df[-split_index, ]
```

```{r}
rf_train <- train_df
rf_test <- test_df
```

```{r}
rf_formula <- total_trips ~ temp + pressure + humidity + wind_speed +
                             cloudiness + hour + weather_main

final_rf <- randomForest(
  rf_formula,
  data = rf_train,
  mtry = 4,
  ntree = 500,
  nodesize = 10,
  importance=TRUE
)
```

```{r}
# Prepare importance dataframe
imp_raw <- importance(final_rf)
importance_df <- data.frame(
  Variable = rownames(imp_raw),
  Importance = imp_raw[, "%IncMSE"]
)

importance_df <- importance_df |>
  arrange(Importance) |>
  mutate(
    Label = paste0(round(Importance, 1), "%"),
    Variable = factor(Variable, levels = Variable)
  )

# Plot with enhancements
p2 <- plot_ly(
  data = importance_df,
  x = ~Importance,
  y = ~Variable,
  type = "bar",
  orientation = "h",
  text = ~Label,
  textposition = "inside",
  insidetextanchor = "start",  # move text slightly inside
  textfont = list(color = "black", size = 12),
  marker = list(
    color = ~Importance,
    colorscale = list(
      c(0, "#FFFFB2"), c(0.25, "#FECC5C"),
      c(0.5, "#FD8D3C"), c(0.75, "#F03B20"), c(1, "#BD0026")
    ),
    line = list(color = "black", width = 0.5)
  ),
  hovertemplate = paste(
    "<b>%{y}</b><br>",
    "Importance: %{x:.1f}%<extra></extra>"
  ),
  height = 500
) |>
layout(
  title = list(
    text = paste0("Feature Importance for Random Forest (Cross-Validated)<br>",
                  "<sup>mtry = ", 4,
                  ", ntree = ", 500,
                  ", nodesize = ", 10, "</sup>"),
    x = 0.5,
    font = list(size = 18)
  ),
  xaxis = list(title = "Importance (%IncMSE)", titlefont = list(size = 14)),
  yaxis = list(
    title = "",
    tickfont = list(size = 14),
    tickpadding = 20,  # Add space between y-axis and y labels
    automargin = TRUE  # Ensures enough margin is added if needed
  ),
  margin = list(l = 180, r = 40, t = 100, b = 50),
  showlegend = FALSE,
  paper_bgcolor = "#ffffff",
  plot_bgcolor = "#ffffff"
)
```

```{r}
pred_vs_actual <- tibble(
  actual = rf_test$total_trips,
  predicted = predict(final_rf, newdata = rf_test)
) %>%
  mutate(abs_error = abs(actual - predicted))

# Compute R²
rsq <- cor(pred_vs_actual$actual, pred_vs_actual$predicted)^2
```

```{r}
pred_vs_actual <- pred_vs_actual %>%
  mutate(residual = abs(predicted - actual))

axis_min <- min(pred_vs_actual$actual, pred_vs_actual$predicted)
axis_max <- max(pred_vs_actual$actual, pred_vs_actual$predicted)

p3 <- plot_ly() %>%
  add_trace(
    data = pred_vs_actual,
    x = ~actual,
    y = ~predicted,
    type = "scatter",
    mode = "markers",
    marker = list(
      color = ~residual,
      colorscale = "YlOrRd",
      colorbar = list(title = "Absolute Error"),
      opacity = 0.6,
      size = 6
    ),
    text = ~paste("Actual:", actual,
                  "<br>Predicted:", round(predicted, 1),
                  "<br>Absolute Error:", round(residual, 1)),
    hoverinfo = "text",
    name = "Predictions"
  ) %>%
  add_trace(
    x = c(axis_min, axis_max),
    y = c(axis_min, axis_max),
    type = "scatter",
    mode = "lines",
    line = list(dash = "dash", color = "gray"),
    showlegend = FALSE,
    hoverinfo = "none"
  ) %>%
  layout(
    title = list(text = "Predicted vs. Actual Bike Trip Counts<br><sup>Colored by Absolute Error (Random Forest)</sup>", x = 0.5),
    xaxis = list(title = "Actual Bike Trips"),
    yaxis = list(title = "Predicted Bike Trips"),
    hovermode = "closest"
  )
```